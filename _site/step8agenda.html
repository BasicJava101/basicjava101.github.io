<!DOCTYPE HTML>
<!--
	Editorial by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>

<head>
  <title>Phoenix Basics</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <!--[if lte IE 8]><script src="/assets/js/ie/html5shiv.js"></script><![endif]-->
  <link rel="stylesheet" href="/assets/css/main.css" />
  <!--[if lte IE 9]><link rel="stylesheet" href="/assets/css/ie9.css" /><![endif]-->
  <!--[if lte IE 8]><link rel="stylesheet" href="/assets/css/ie8.css" /><![endif]-->
</head>


<body>

    <!-- Wrapper -->
    <div id="wrapper">

        <!-- Main -->
        <div id="main">
            <div class="inner">
              <header id="header">
                <a href="http://localhost:9000/" class="logo">
                  <img src="/assets/images/java.png">
                </a>
              </header>

                <!-- Content -->
                <section>
                	<header class="main">
                		<h1>API - Add talks to agenda</h1>
                	</header>

                  

                <p>(Use <code class="highlighter-rouge">git checkout 8.agenda</code> to catch up with the class)</p>

<p>We need a way for user to add a talk to their agenda. Run this command to generate a user talk relationship.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mix phx.gen.json Agenda UserTalk users_talks user_id:references:users talk_id:references:talks
</code></pre></div></div>

<p>Open up <code class="highlighter-rouge">lib/fawkes/agenda/user_talk.ex</code>. Add <code class="highlighter-rouge">:user_id</code> and <code class="highlighter-rouge">:talk_id</code> to the cast so your changeset will look like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def changeset(user_talk, attrs) do
  user_talk
  |&gt; cast(attrs, [:user_id, :talk_id])
  |&gt; validate_required([])
end
</code></pre></div></div>

<p>In the <code class="highlighter-rouge">router</code>, add an api scope for <code class="highlighter-rouge">user_talk</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scope "/api", FawkesWeb do
  pipe_through [:api]

  resources "/users_talks", UserTalkController, except: [:new, :edit]
end
</code></pre></div></div>

<p>Open up the <code class="highlighter-rouge">lib/fawkes_web/controller/user_talk_controller.ex</code>, and don’t match the param. Change the param to <code class="highlighter-rouge">user_talk_params</code>, like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def create(conn, user_talk_params) do
  with {:ok, %UserTalk{} = user_talk} &lt;- Agenda.create_user_talk(user_talk_params) do
    conn
    |&gt; put_status(:created)
    |&gt; put_resp_header("location", user_talk_path(conn, :show, user_talk))
    |&gt; render("show.json", user_talk: user_talk)
  end
end
</code></pre></div></div>

<p>Run the migration to create the table:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mix ecto.migrate
</code></pre></div></div>

<p>Now we’re ready to save! Go to <a href="http://localhost:4000/schedule_slots">http://localhost:4000/schedule_slots</a>, click add to agenda on a few slot. We added the javascript to handle the add. If you open up your console, you can see the JSON the server sends.</p>

<h3 id="showing-my-agenda">Showing my agenda</h3>
<p>(Use <code class="highlighter-rouge">git checkout 8a.show_agenda</code> to catch up with the class)</p>

<p>Let’s get our agendas. In your <code class="highlighter-rouge">router</code>, below <code class="highlighter-rouge">resources "/speakers", SpeakerController</code>, add a path to retrieve your agenda</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>get "/agenda", AgendaController, :index
</code></pre></div></div>

<p>When the user hits this endpoint, we will retrieve all the talks for the current user. Let’s create a new controller called <code class="highlighter-rouge">lib/fawkes_web/controller/agenda_controller.ex</code>. Add this code:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defmodule FawkesWeb.AgendaController do
  use FawkesWeb, :controller

  alias Fawkes.Agenda

  def index(conn, _params) do
    talks = Agenda.list_talk_for_user(conn.assigns.current_user.id)
    render(conn, "index.html", talks: talks)
  end
end
</code></pre></div></div>

<p>Open <code class="highlighter-rouge">lib/fawkes/agenda/agenda.ex</code>, add in this function to retrieve the talks:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>alias Fawkes.Schedule.Talk

def list_talk_for_user(user_id) do
  Talk
  |&gt; preload([:slot, :speakers, :categories, :audience, :location])
  |&gt; join(:inner, [talk], user_talk in UserTalk, user_talk.talk_id == talk.id and user_talk.user_id == ^user_id)
  |&gt; Repo.all()
end
</code></pre></div></div>

<p>Now that we retrieved the talk, let’s display it. Create a new file called <code class="highlighter-rouge">lib/fawkes_web/views/agenda_view.ex</code>. Add this code to render the view:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defmodule FawkesWeb.AgendaView do
  use FawkesWeb, :view
end
</code></pre></div></div>

<p>Now let’s get the HTML for the view. Create a new folder called <code class="highlighter-rouge">lib/fawkes_web/templates/agenda</code>. Create a new file called <code class="highlighter-rouge">lib/fawkes_web/templates/agenda/index.html.eex</code>. Add this code to display the data:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;div class="talk-index"&gt;
  &lt;div class="section-white"&gt;
    &lt;div class="container"&gt;
      &lt;div class="d-flex justify-content-center align-items-center dates"&gt;
        &lt;i class="fas fa-arrow-left"&gt;&lt;/i&gt;
        &lt;%= for {day_number, day_name} &lt;- [{4, "Tue"}, {5, "Wed"}, {6, "Thu"}, {7, "Fri"}] do %&gt;
          &lt;div class="card"&gt;
            &lt;div class="card-body"&gt;
              &lt;div class="dates__name smalltext"&gt;&lt;%= day_name %&gt;&lt;/div&gt;
              &lt;div class="dates__number"&gt;&lt;%= day_number %&gt;&lt;/div&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;% end %&gt;
        &lt;i class="fas fa-arrow-right"&gt;&lt;/i&gt;
      &lt;/div&gt;
      &lt;div class="d-flex justify-content-center talk-index__tab"&gt;
        &lt;a href="/schedule_slots" class="talk-tab__link"&gt;&lt;h4 class="subheader"&gt;Full Schedule&lt;/h4&gt;&lt;/a&gt;
        &lt;a href="/agenda" class="talk-tab__link talk-tab__link-active"&gt;&lt;h4 class="subheader"&gt;My Agenda&lt;/h4&gt;&lt;/a&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;

  &lt;div class="container schedule"&gt;
    &lt;%= for talk &lt;- @talks do %&gt;
      &lt;div class="card"&gt;
        &lt;div class="card-body"&gt;
          &lt;div class="float-right schedule__talk-link"&gt;&lt;i class="fas fa-angle-right"&gt;&lt;/i&gt;&lt;/div&gt;
          &lt;h4 class="subheader"&gt;&lt;%= Timex.format!(talk.slot.start_time, "%-I:%M %p", :strftime)%&gt; - &lt;%= Timex.format!(talk.slot.end_time, "%-I:%M %p", :strftime) %&gt;&lt;/h4&gt;
          &lt;a href="/talks/&lt;%= talk.id %&gt;"&gt;&lt;h3 class="schedule__talk-title"&gt;&lt;%= talk.title %&gt;&lt;/h3&gt;&lt;/a&gt;

          &lt;div class="schedule__details"&gt;&lt;%= FawkesWeb.SharedView.full_name(talk.speakers) %&gt; &amp;nbsp; | &amp;nbsp; &lt;%= talk.location.name %&gt;&lt;/div&gt;
          &lt;p class="icons"&gt;
            &lt;button class="btn talk__audience"&gt;&lt;%= talk.audience.name %&gt;&lt;/button&gt;
            &lt;%= for category &lt;- talk.categories do %&gt;
                &lt;%= if category.icon_url do %&gt;
                  &lt;img src="&lt;%= category.icon_url %&gt;"&gt;
                &lt;% else %&gt;
                &lt;button class="btn talk__category"&gt;
                  &lt;%= category.name %&gt;
                &lt;/button&gt;
                &lt;% end %&gt;
            &lt;% end %&gt;
          &lt;/p&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;% end %&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre></div></div>

<p>Go to <a href="http://localhost:4000/agendas">http://localhost:4000/agendas</a>. Note the talks you added are there.</p>

<h3 id="exercise-view-other-user-agenda">Exercise: View other user agenda</h3>
<p>(Use <code class="highlighter-rouge">git checkout 8b.others_agenda</code> to catch up with the class)</p>

<ol>
  <li>Add a new endpoint <code class="highlighter-rouge">/agenda/:user_slug</code></li>
  <li>Add a new function in the <code class="highlighter-rouge">lib/fawkes_web/controller/agenda_controller.ex</code>
    <ul>
      <li>First find the profile with the given slug</li>
      <li>Find all the talks the user added to their profile given the user_id in the profile</li>
    </ul>
  </li>
  <li>Since you’re only displaying the talk, you can reuse the index template <code class="highlighter-rouge">render(conn, "index.html", talks: talks)</code></li>
</ol>


              </div>
          </div>

          <!-- Sidebar -->
  <div id="sidebar">
    <div class="inner">
      <!-- Menu -->
        <nav id="menu">
          <header class="major">
            <h2>Menu</h2>
          </header>
          <ul>
            <li><a href="index.html">0. Getting started</a></li>
            <li><a href="01-datatype.html">1. Data Types</a></li>
            <li><a href="02-variable.html">2. Variable</a></li>
            <li><a href="03-math-operations.html">3. Math Operations</a></li>
            <li><a href="04-class-method.html">4. Class & Method</a></li>
            <li><a href="04-class-method.html">. Object</a></li>
            <li><a href="04-class-method.html">. Wrapper Class</a></li>
            <li><a href="0-string.html">. String</a></li>
            <li><a href="0-array.html">. Array</a></li>
            <li><a href="0-for-loop.html">. For Loop</a></li>
            <li><a href="0-while-loop.html">. While Loop</a></li>
          </ul>
        </nav>

      <!-- Footer -->
        <footer id="footer">
          <p class="copyright">&copy; Phoenix Basics. All rights reserved. Demo Images: <a href="https://unsplash.com">Unsplash</a>. Design: <a href="https://html5up.net">HTML5 UP</a>. Jekyll integration: <a href="https://andrewbanchi.ch">Andrew Banchich</a>.</p>
        </footer>

    </div>
  </div>


      </div>

      <!-- Scripts -->
  <script src="http://localhost:9000/assets/js/jquery.min.js"></script>
  <script src="http://localhost:9000/assets/js/skel.min.js"></script>
  <script src="http://localhost:9000/assets/js/util.js"></script>
  <!--[if lte IE 8]><script src="http://localhost:9000/assets/js/ie/respond.min.js"></script><![endif]-->
  <script src="http://localhost:9000/assets/js/main.js"></script>


</body>

</html>
