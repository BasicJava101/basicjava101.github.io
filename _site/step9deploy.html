<!DOCTYPE HTML>
<!--
	Editorial by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>

<head>
  <title>Phoenix Basics</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <!--[if lte IE 8]><script src="/assets/js/ie/html5shiv.js"></script><![endif]-->
  <link rel="stylesheet" href="/assets/css/main.css" />
  <!--[if lte IE 9]><link rel="stylesheet" href="/assets/css/ie9.css" /><![endif]-->
  <!--[if lte IE 8]><link rel="stylesheet" href="/assets/css/ie8.css" /><![endif]-->
</head>


<body>

    <!-- Wrapper -->
    <div id="wrapper">

        <!-- Main -->
        <div id="main">
            <div class="inner">
              <header id="header">
                <a href="http://localhost:9000/" class="logo">
                  <img src="/assets/images/conflogo.png">
                  <strong>Phoenix Basics</strong> 
                </a>
              </header>

                <!-- Content -->
                <section>
                	<header class="main">
                		<h1>Deploy</h1>
                	</header>

                  

                <h3 id="configs">Configs</h3>

<p>(Use <code class="highlighter-rouge">git checkout 9.deploy</code> to catch up with the class)</p>

<ol>
  <li>Open up <code class="highlighter-rouge">config/prod.exs</code>, add a comma to <code class="highlighter-rouge">cache_static_manifest: "priv/static/cache_manifest.json",</code>. Then add this below it:</li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>secret_key_base: Map.fetch!(System.get_env(), "SECRET_KEY_BASE")
</code></pre></div></div>

<p>Scroll to the bottom of the file, remove <code class="highlighter-rouge">import_config "prod.secret.exs"</code>. Add this database setting to the file:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>config :fawkes, Fawkes.Repo,
  adapter: Ecto.Adapters.Postgres,
  url: System.get_env("DATABASE_URL"),
  pool_size: String.to_integer(System.get_env("POOL_SIZE") || "10"),
  ssl: true
</code></pre></div></div>

<p>Your <code class="highlighter-rouge">config/prod.exs</code> file should look like this (without the comments):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>use Mix.Config

config :fawkes, FawkesWeb.Endpoint,
  load_from_system_env: true,
  url: [host: "example.com", port: 80],
  cache_static_manifest: "priv/static/cache_manifest.json",
  secret_key_base: Map.fetch!(System.get_env(), "SECRET_KEY_BASE")

config :logger, level: :info

config :fawkes,
   FawkesWeb.Guardian.Tokenizer,
   issuer: "fawkes",
   secret_key: System.get_env("GUARDIAN_KEY")

config :fawkes, Fawkes.Repo,
  adapter: Ecto.Adapters.Postgres,
  url: System.get_env("DATABASE_URL"),
  pool_size: String.to_integer(System.get_env("POOL_SIZE") || "10"),
  ssl: true
</code></pre></div></div>

<h3 id="deploy">Deploy</h3>

<ol>
  <li>Create a new file in the root application called <code class="highlighter-rouge">deploy.sh</code></li>
  <li>Add this content to the file</li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  heroku create --buildpack "https://github.com/HashNuke/heroku-buildpack-elixir.git"
  heroku buildpacks:add https://github.com/gjaldon/heroku-buildpack-phoenix-static.git
  touch Procfile
  echo "web: MIX_ENV=prod mix phx.server" &gt; Procfile
  heroku addons:create heroku-postgresql:hobby-dev
  heroku config:set POOL_SIZE=18
  heroku config:set SECRET_KEY_BASE=""
  heroku config:set GUARDIAN_KEY=""

  heroku config:set S3_BUCKET="aaa"
  heroku config:set AWS_ACCESS_KEY="aaa"
  heroku config:set AWS_SECRET_KEY="aaa"

  git push heroku master

  heroku run "POOL_SIZE=2 mix ecto.migrate"
  heroku run "POOL_SIZE=2 mix run priv/repo/seeds.exs"
</code></pre></div></div>

<ol>
  <li>Run <code class="highlighter-rouge">mix phx.gen.secret</code> and set the SECRET_KEY_BASE to the generated string</li>
  <li>Run <code class="highlighter-rouge">mix phx.gen.secret</code> and set the GUARDIAN_KEY to the generated string</li>
  <li>Add in your S3 bucket, access key, and secret key</li>
  <li>If youâ€™re on a branch, change <code class="highlighter-rouge">git push heroku master</code> to <code class="highlighter-rouge">git push heroku branchname:master</code></li>
  <li>Run <code class="highlighter-rouge">chmod u+x deploy.sh</code> to make the file executable</li>
  <li>Run <code class="highlighter-rouge">./deploy.sh</code></li>
</ol>


              </div>
          </div>

          <!-- Sidebar -->
  <div id="sidebar">
    <div class="inner">
      <!-- Menu -->
        <nav id="menu">
          <header class="major">
            <h2>Menu</h2>
          </header>
          <ul>
            <li><a href="index.html">0. Getting started</a></li>
            <li><a href="step1newapp.html">1. Create new project</a></li>
            <li><a href="step2addpage.html">2. Add a new page</a></li>
            <li><a href="step3addcategory.html">3. Add a feature</a></li>
            <li><a href="step3addcategoryanswer.html">3a. Add a feature answer</a></li>
            <li><a href="step4phoenixgenerator.html">4. Phoenix Generator</a></li>
            <li><a href="step5seed.html">5. Populate the database</a></li>
            <li><a href="step5seedanswer.html">5. Populate the database answer</a></li>
            <li><a href="step6usersignin.html">6. Add Member Signup</a></li>
            <li><a href="step7userprofiles.html">7. Add User Profiles</a></li>
            <li><a href="step8agenda.html">8. Add agenda</a></li>
            <li><a href="step9deploy.html">9. Deploy</a></li>
            <li><a href="step10bonus.html">10. Bonus exercise</a></li>
          </ul>
        </nav>

      <!-- Footer -->
        <footer id="footer">
          <p class="copyright">&copy; Phoenix Basics. All rights reserved. Demo Images: <a href="https://unsplash.com">Unsplash</a>. Design: <a href="https://html5up.net">HTML5 UP</a>. Jekyll integration: <a href="https://andrewbanchi.ch">Andrew Banchich</a>.</p>
        </footer>

    </div>
  </div>


      </div>

      <!-- Scripts -->
  <script src="http://localhost:9000/assets/js/jquery.min.js"></script>
  <script src="http://localhost:9000/assets/js/skel.min.js"></script>
  <script src="http://localhost:9000/assets/js/util.js"></script>
  <!--[if lte IE 8]><script src="http://localhost:9000/assets/js/ie/respond.min.js"></script><![endif]-->
  <script src="http://localhost:9000/assets/js/main.js"></script>


</body>

</html>
